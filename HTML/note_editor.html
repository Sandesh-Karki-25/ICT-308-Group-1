<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>I-NOTES-Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <aside class="sidebar">
    <h2>I-NOTES</h2>
    
    <nav> 
      <ul>
         <li><a href="dashboard.html">Dashboard</a></li>
        <li><a href="fav.html">Favourites</a></li>
        <li><a href="all.html">All Notes</a></li>
      </ul>
    </nav>
 </aside>

  <main class="main">
    <header>
       <div class="logo-container">
      <img src="cihelogo.png" alt="CIHE Background Logo" class="logo-background">
      <img src="cihelogo.png" alt="CIHE Logo" class="main-logo"></div>
       
      <div class="search-container"> 
         <form class="search-form-inline" action="">
        <input type="text" placeholder="Search notes..." class="search-bar" aria-label="Search notes">
        <button class="search-button">
          <img src="search.png" alt="Search Icon" class="search-icon">
        </button></form>
        <img id="bmode"  src="dark.png"  >
        <!-- User Menu -->
         <div class="user-menu">
  <div class="user" id="userBtn">SS</div>
  <div class="dropdown" id="userDropdown">
    <ul>
      <li><a href="#" role="button" onclick="openProfileModal()">Profile</a></li>
       <li><a href="#" role="button" onclick="openSettingsModal()">Settings</a></li>
      <li><a href="login.html" >Logout</a></li>
    </ul>
       
  </div>
</div>
</div>
    </div>
 </header>
    


    <div class="format">
      <button class="format-btn" id="bold-btn">B</button>
      <button class="format-btn" id="italic-btn">I</button>
      <button class="format-btn" id="underline-btn">U</button>
      
      <select id="fontSelect">
    <option value="ui">Sans (Inter)</option>
    <option value="serif">Serif (Merriweather)</option>
    <option value="mono">Mono</option>
  </select>
   <div class="color-picker-container">
        <button class="format-btn" id="color-btn" title="Text Color"><img class="color" src="color.png" alt="Text color" /></button>
        <div class="color-picker" id="colorPicker" role="menu" aria-label="Text colors">
          <div class="color-option" style="background:#000000" data-color="#000000" title="Black"></div>
          <div class="color-option" style="background:#ff0000" data-color="#ff0000" title="Red"></div>
          <div class="color-option" style="background:#00aa00" data-color="#00aa00" title="Green"></div>
          <div class="color-option" style="background:#0000ff" data-color="#0000ff" title="Blue"></div>
          <div class="color-option" style="background:#ff9900" data-color="#ff9900" title="Orange"></div>
          <div class="color-option" style="background:#ff00ff" data-color="#ff00ff" title="Magenta"></div>
          <div class="color-option" style="background:#9966ff" data-color="#9966ff" title="Purple"></div>
          <div class="color-option" style="background:#0099ff" data-color="#0099ff" title="Cyan"></div>
        </div>
      </div>

       <!-- List controls: main button + horizontal options -->
     <div class="list-menu-wrap">
        <button class="format-btn" id="list-btn" title="Bulleted list">
          <img class="list" src="list.png" alt="Insert list"/>
        </button>
        <div class="list-menu" id="listMenu" role="menu" aria-label="List options">
          <button type="button" id="opt-bulleted" title="Bulleted list">
            <span class="list-icon">•</span>
            <span class="list-label">Bulleted</span>
          </button>
          <button type="button" id="opt-numbered" title="Numbered list">
            <span class="list-icon">1.</span>
            <span class="list-label">Numbered</span>
          </button>
          <button type="button" id="opt-checklist" title="Checklist">
            <span class="list-icon">☑</span>
            <span class="list-label">Checklist</span>
          </button>
          <button type="button" id="opt-indent" title="Increase indent">
            <span class="list-icon">→</span>
            <span class="list-label">Indent</span>
          </button>
          <button type="button" id="opt-outdent" title="Decrease indent">
            <span class="list-icon">←</span>
            <span class="list-label">Outdent</span>
          </button>
        </div>
      </div>
      </div>
    </div>
  
        <!-- Note Title -->
     <div> <input type="text" class="note-title" placeholder="Enter note title..." aria-label="Note title">
    </div>
    <!-- Note writing area -->

    <div id="note-area" contenteditable="true" placeholder="Start writing your note here..."></div>

      <!-- Audio buttons -->
      <div class="audio-controls">
        <button id="record-btn"> Start Recording</button>
        <button id="speech-btn"> Speech to Text</button>
        <img class="fav-btn" id="favBtn" src="star.png"> 
      </div>

      <!-- Buttons -->
      <div class="note-actions">
        <button class="save-btn"> Save</button>
        <button class="cancel-btn"> Cancel</button>
     <button class="share-button" onclick="openModal()"><img class="share" src="share.png"></button> 
         <div class="share-list" id="shareList"></div>
      </div>

       <!-- Audio recordings list -->
      <div class="audio-recordings">
        <h3>Audio Recordings</h3>
        <div class="recordings-list" id="recordingsList">
          <!-- Recordings will be dynamically added here -->
        </div>
      </div>
    </div>
  </main>
      <!-- Overlay + Modal -->
<div class="share-overlay" id="shareOverlay">
  <div class="share-popup">
    <span class="close-btn" onclick="closeModal()">✖</span>

    <!-- Email input + share button -->
    <div class="email-share">
      <input type="email" id="emailInput" placeholder="Enter email">
      <button onclick="shareByEmail()">Share</button>
    </div>

    <!-- Copy link -->
    <div class="copy-link">
      <button onclick="copyLink()"> Copy Link</button>
    </div>
  </div>
</div>



<!-- Profile Modal -->
  <div class="profile-modal" id="profileModal">
    <div class="profile-content">
      <div class="profile-header">
        <h2 id="modalTitle">Profile</h2>
        <span class="close-btn" onclick="closeProfileModal()" role="button">✖</span>
        
      </div>
      <div class="tab-content">
        <!-- Profile Tab -->
        
          <div class="profile-info">
            <div class="profile-avatar">SS</div>
            <div class="profile-details">
              <h3>Sarah Smith</h3>
              <p>sarah.smith@example.com</p>
            </div>
          </div>
          
          <div class="form-group">
            <label for="fullName">Full Name</label>
            <input type="text" id="fullName" value="Sarah Smith">
          </div>
          
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" value="sarah.smith@example.com">
          </div>
          
          <div class="form-group">
            <label for="bio">Bio</label>
            <input type="text" id="bio" value="UX Designer & Note Taker">
          </div>
        
      </div>
    </div>
  </div>

  <div class="settings-modal" id="settingsModal">
     <div class="setttings-content">
      <div class="settings-header">
       <h2 id="modalTitle">Settings</h2>
       <span class="close-btn" onclick="closeSettingsModal()">✖</span>
      </div>
      
      
      
      <div id="settings-tab" class="tab-pane">
        <div class="form-group">
          <label>Body Font Size: <span id="bodySizeValue">16</span>px</label>
          <div class="slider-container">
            <input type="range" id="bodyFontSize" min="12" max="24" value="16" oninput="updateBodyFontSize(this.value)">
            <div class="slider-value" id="bodySizeValueDisplay">16px</div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Heading Font Size: <span id="headingSizeValue">24</span>px</label>
          <div class="slider-container">
            <input type="range" id="headingFontSize" min="18" max="36" value="24" oninput="updateHeadingFontSize(this.value)">
            <div class="slider-value" id="headingSizeValueDisplay">24px</div>
          </div>
        </div>
      </div>
     </div>
  </div>

  </main>
  <script src = "profile.js"></script>
  <script src="notes.js"></script>
  <script src="share.js"></script>
  <script src="color.js"></script>
</body>
</html>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const folderId = sessionStorage.getItem('currentFolderId');
    const noteId = sessionStorage.getItem('editNoteId');
    const isEditing = !!noteId;

    // This flag will track if a NEW recording has been made on this page.
    let newAudioRecorded = false;
    
    // This flag will track if the user wants to delete existing audio.
    let deleteExistingAudio = false;

    // Allow editing even if folderId is not present (for unfiled notes).
    // Only redirect if we are creating a NEW note without a folder context.
    // The `noteId` tells us we are editing, so the folderId check can be skipped.
    if (!isEditing && !folderId) {
      alert('No folder selected for new note!');
      window.location.href = 'dashboard.html';
      return;
    }

    // If editing, fetch the note data
    if (isEditing) {
        fetch(`get_note_details.php?note_id=${noteId}`)
            .then(res => res.json())
            .then(note => {
                if (note) {
                    document.querySelector('.note-title').value = note.title;
                    document.getElementById('note-area').innerHTML = note.body;

                    // Check for and display existing audio from localStorage
                    const audioData = localStorage.getItem('audio_note_' + noteId);
                    if (audioData) {
                        const recordingsList = document.getElementById('recordingsList');
                        recordingsList.innerHTML = `
                            <div class="recording-item">
                                <div class="recording-info">
                                    <div class="recording-title"> Audio one </div>
                                </div>
                                <div class="audio-player-container" style="margin-top: 10px; display: flex; align-items: center; gap: 10px;">
                                    <audio controls src="${audioData}"></audio>
                                    <button class="delete-audio-btn cancel-btn" title="Delete this audio recording">Delete</button>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    alert('Could not find the note to edit.');
                    sessionStorage.removeItem('editNoteId'); // Clean up
                    window.location.href = 'dashboard.html';
                }
            })
            .catch(err => {
                console.error('Error fetching note details:', err);
                alert('Error loading note for editing.');
            });
    }
    
    // Add event listener for the delete audio button (using event delegation)
    document.getElementById('recordingsList').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('delete-audio-btn')) {
            if (confirm('Are you sure you want to delete this audio recording?')) {
                // Set the flag and remove the player from the view
                localStorage.removeItem('audio_note_' + noteId);
                
                const recordingItem = e.target.closest('.recording-item');
                recordingItem.remove();
                alert('Audio marked for deletion. Click "Save" to confirm.');
            }
        }
    });

    // In notes.js, mediaRecorder.onstop is defined. We will enhance it here
    // to set our flag when a new recording is finished.
    // We need to wait for the mediaRecorder object to be created by notes.js
    document.getElementById('record-btn').addEventListener('click', () => {
        if (mediaRecorder && !mediaRecorder.onstop.isEnhanced) {
            const originalOnStop = mediaRecorder.onstop;
            mediaRecorder.onstop = (...args) => { newAudioRecorded = true; if (originalOnStop) originalOnStop.apply(this, args); };
            mediaRecorder.onstop.isEnhanced = true; // Prevent re-binding
        }
    }, { once: true }); // Only need to set this up once

    document.querySelector('.save-btn').onclick = function() {
        const title = document.querySelector('.note-title').value.trim();
        const body = document.getElementById('note-area').innerHTML;

        if (!title.trim()) {
            alert('Please enter a note title.');
            return;
        }
 
        let url = isEditing ? 'update_note.php' : 'save_note.php';
        let params = "title=" + encodeURIComponent(title) +
                     "&body=" + encodeURIComponent(body);

        if (isEditing) {
            params += "&note_id=" + encodeURIComponent(noteId);
        } else {
            params += "&folder_id=" + encodeURIComponent(folderId);
        }
 
        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params
        })
        .then(async (res) => {
            const isJson = res.headers.get('content-type')?.includes('application/json');
            const data = isJson ? await res.json() : await res.text();

            if (!res.ok) {
                const error = (data && data.message) || data || res.statusText; // Corrected duplicate declaration
                throw new Error(error);
            }

            const message = data.message || data; // Get message from JSON or use the text response
            alert(message);
            // alert(message); // Alert can be annoying, let's rely on the redirect.

            const noteIdToUse = isEditing ? noteId : data.note_id;
            if (newAudioRecorded && window.currentAudioData) {
                // If a new recording was made, save the audio data string
                localStorage.setItem('audio_note_' + noteIdToUse, window.currentAudioData);
            }
            // Always clean up session storage after saving
            sessionStorage.removeItem('editNoteId');
            sessionStorage.removeItem('currentFolderId');
            window.location.href = 'dashboard.html'; // Redirect on success
        })
        .catch(err => {
            console.error('Error saving note:', err);
            alert('An error occurred while saving the note.');
        });
    };

    document.querySelector('.cancel-btn').onclick = function() {
        // Clean up sessionStorage on cancel
        sessionStorage.removeItem('editNoteId');
        window.location.href = 'dashboard.html';
    };
});

</script>