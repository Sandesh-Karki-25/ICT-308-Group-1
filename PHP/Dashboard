<?php
session_start();
if (!isset($_SESSION['student_id'])) {
    header("Location: /notes/login.html?error=" . urlencode("Please log in."));
    exit();
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>I-NOTES â€“ Dashboard</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <aside class="sidebar">
    <h2>I-NOTES</h2>
    <button class="new-note" onclick="window.location.href='notes.php'">+ New Note</button>
    <nav>
      <ul>
        <li><a href="dashboard.php">Dashboard</a></li>
        <li><a href="fav.php">Favourites</a></li>
        <li><a href="all.php">All Notes</a></li>
      </ul>
    </nav>
  </aside>

  <main class="main">
    <header>
      <div class="logo-container">
        <img src="cihelogo.png" alt="CIHE Background Logo" class="logo-background">
        <img src="cihelogo.png" alt="CIHE Logo" class="main-logo">
      </div>
      <h2>Dashboard</h2>
      <div class="search-container">
      <form class="search-form-inline" id="searchForm" action="#" onsubmit="event.preventDefault(); doSearch();">
  <input type="text" placeholder="Search notes..." class="search-bar" id="searchInput" aria-label="Search notes">
  <button class="search-button" type="submit">
    <img src="search.png" alt="Search Icon" class="search-icon">
  </button>
</form>
<div id="searchResults"></div>
        <img id="bmode" src="dark.png" alt="Toggle dark mode">
        <div class="user-menu">
          <div class="user" id="userBtn"><?php echo htmlspecialchars($_SESSION['username'][0] ?? 'U'); ?></div>
          <div class="dropdown" id="userDropdown">
            <ul>
              <li><a href="#" onclick="openProfileModal(); return false;">Profile</a></li>
              <li><a href="#" onclick="openSettingsModal(); return false;">Settings</a></li>
              <li><a href="logout.php">Logout</a></li>
            </ul>
          </div>
        </div>
      </div>
    </header>

    <section class="content">
      <div class="section-title"><h2>Folders</h2></div>
      <button class="add-folder" onclick="openModal()">+ Add folders</button>
      <div class="folder-list" id="folderList"></div>
      <!-- Modal -->
      <div class="modal" id="folderModal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3>Add Folder</h3>
    <input type="text" id="folderNameInput" placeholder="Enter folder name">
    <div class="modal-container">
      <button onclick="createFolder()">Create</button>
    </div>
  </div>
</div>
    </section>
  </main>

  <!-- scripts -->
  <script src="profile.js"></script>
  <script src="notes.js"></script>
  <script src="folders.js"></script>
  <script>
    // Simple search handler (redirect to All page with ?q=)
    function doSearch() {
      const q = document.getElementById('searchInput').value.trim();
      const url = new URL('all.php', location.href);
      if (q) url.searchParams.set('q', q);
      location.href = url.toString();
    }

    // Folder modal logic (same as your HTML dashboard)
    let folders = [];
    window.onload = function() {
      const savedFolders = localStorage.getItem('folders');
      if (savedFolders) {
        folders = JSON.parse(savedFolders);
        renderFolders();
      }
    };
    function openModal() {
      document.getElementById('folderModal').style.display = 'block';
    }
    function closeModal() {
      document.getElementById('folderModal').style.display = 'none';
      document.getElementById('folderNameInput').value = '';
    }
    function createFolder() {
      const folderName = document.getElementById('folderNameInput').value.trim();
      if (folderName) {
        folders.push(folderName);
        localStorage.setItem('folders', JSON.stringify(folders));
        renderFolders();
        closeModal();
      }
    }
    function renderFolders() {
      const folderList = document.getElementById('folderList');
      folderList.innerHTML = '';
      folders.forEach((name, idx) => {
        const a = document.createElement('a');
        a.className = 'folder-item';
        a.textContent = name;
        a.href = `folder.php?name=${encodeURIComponent(name)}`;
        a.style.textDecoration = 'none';
        folderList.appendChild(a);
      });
    }
    window.onclick = function(event) {
      const modal = document.getElementById('folderModal');
      if (event.target == modal) {
        closeModal();
      }
    }

    function doSearch() {
  const q = document.querySelector('.search-bar').value.trim().toLowerCase();
  const searchResults = document.getElementById('searchResults');
  searchResults.innerHTML = '';

  if (!q) return;

  // Search folders
  const folders = JSON.parse(localStorage.getItem('folders') || '[]');
  folders.forEach(folder => {
    if (folder.toLowerCase().includes(q)) {
      const a = document.createElement('a');
      a.textContent = `Folder: ${folder}`;
      a.href = `folder.html?name=${encodeURIComponent(folder)}`;
      a.className = 'search-result';
      searchResults.appendChild(a);
      searchResults.appendChild(document.createElement('br'));
    }
  });

  // Search notes in all folders
  for (let key in localStorage) {
    if (key.startsWith('notes_')) {
      const folderName = key.replace('notes_', '');
      const notes = JSON.parse(localStorage.getItem(key));
      notes.forEach((note, idx) => {
        if (
          (note.title && note.title.toLowerCase().includes(q)) ||
          (note.content && note.content.toLowerCase().includes(q))
        ) {
          const a = document.createElement('a');
          a.textContent = `Note: ${note.title} (in ${folderName})`;
          a.href = `notes.html?folder=${encodeURIComponent(folderName)}&note=${idx}`;
          a.className = 'search-result';
          searchResults.appendChild(a);
          searchResults.appendChild(document.createElement('br'));
        }
      });
    }
  }
}
  </script>
</body>
</html>
