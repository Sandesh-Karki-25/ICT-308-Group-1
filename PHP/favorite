<?php
session_start();
if (!isset($_SESSION['student_id'])) {
    header("Location: /notes/login.html?error=" . urlencode("Please log in."));
    exit();
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>I-NOTES â€“ Folder</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <aside class="sidebar">
    <h2>I-NOTES</h2>
    <button class="new-note" onclick="openNewNote()">+ New Note</button>
    <nav>
      <ul>
        <li><a href="dashboard.php">Dashboard</a></li>
        <li><a href="fav.php">Favourites</a></li>
        <li><a href="all.php">All Notes</a></li>
      </ul>
    </nav>
  </aside>

  <main class="main">
    <header>
      <div class="logo-container">
        <img src="cihelogo.png" alt="CIHE Background Logo" class="logo-background">
        <img src="cihelogo.png" alt="CIHE Logo" class="main-logo">
      </div>
      <h2 id="folderTitle"></h2>
      <div class="search-container">
        <form class="search-form-inline" id="searchForm" action="#" onsubmit="event.preventDefault(); doSearch();">
          <input type="text" placeholder="Search notes..." class="search-bar" id="searchInput" aria-label="Search notes">
          <button class="search-button" type="submit">
            <img src="search.png" alt="Search Icon" class="search-icon">
          </button>
        </form>
        <img id="bmode" src="dark.png" alt="Toggle dark mode">
        <div class="user-menu">
          <div class="user" id="userBtn"><?php echo htmlspecialchars($_SESSION['username'][0] ?? 'U'); ?></div>
          <div class="dropdown" id="userDropdown">
            <ul>
              <li><a href="#">Profile</a></li>
              <li><a href="#">Settings</a></li>
              <li><a href="logout.php">Logout</a></li>
            </ul>
          </div>
        </div>
      </div>
    </header>

    <section class="content">
      <div class="section-title">
        <h2>Favourite Notes</h2>
      </div>
      <div id="favNotesList"></div>
    </section>
  </main>

  <script>
    // Get folder name from URL
    function getFolderName() {
      const params = new URLSearchParams(window.location.search);
      return params.get('name') || 'Folder';
    }
    document.getElementById('folderTitle').textContent = getFolderName();

    // Open notes.php and pass folder name
    function openNewNote() {
      const folderName = getFolderName();
      window.location.href = `notes.php?folder=${encodeURIComponent(folderName)}`;
    }

    // Load and render notes for this folder from localStorage
    let notes = [];
    function loadNotes() {
      const folderName = getFolderName();
      const savedNotes = localStorage.getItem('notes_' + folderName);
      notes = savedNotes ? JSON.parse(savedNotes) : [];
      renderNotes();
    }
    function renderNotes() {
      const notesList = document.getElementById('notesList');
      notesList.innerHTML = '';
      notes.forEach(note => {
        const div = document.createElement('div');
        div.className = 'note-title';
        div.innerHTML = `<strong>${note.title}</strong><br>${note.content}`;
        notesList.appendChild(div);
      });
    }
    window.onload = loadNotes;

    function doSearch() {
      const q = document.getElementById('searchInput').value.trim();
      const url = new URL('all.php', location.href);
      if (q) url.searchParams.set('q', q);
      location.href = url.toString();
    }

    function loadFavourites() {
  let favNotes = [];
  let favLinks = [];
  for (let key in localStorage) {
    if (key.startsWith('notes_')) {
      const notes = JSON.parse(localStorage.getItem(key));
      notes.forEach((note, idx) => {
        if (note.favourite) {
          favNotes.push(note);
          favLinks.push({ folder: key.replace('notes_', ''), idx });
        }
      });
    }
  }
  const favList = document.getElementById('favNotesList');
  favList.innerHTML = '';
  favNotes.forEach((note, i) => {
    const a = document.createElement('a');
    a.className = 'note-title';
    a.innerHTML = `<strong>${note.title}</strong><br>${note.content}`;
    a.href = `notes.php?folder=${encodeURIComponent(favLinks[i].folder)}&note=${favLinks[i].idx}`;
    a.style.display = 'block';
    favList.appendChild(a);
  });
}
window.onload = loadFavourites;
  </script>
</body>
</html>
